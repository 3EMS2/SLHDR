#!/usr/bin/env bash

cxx=g++

prefix="/usr/local"

die() {
   printf "\e[0;31m$*\e[0m\n"
   exit 1
}

show_help() {
    cat <<EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]

Options:
  --help                   print this message
  --cxx=<compiler>         define used compiler[${cxx}]

  --ssedir=DIR             path to slhdr library SSE version
  --avxdir=DIR             path to slhdr library AVX version

  --prefix=PREFIX          install in PREFIX [$prefix_default]
  --libdir=LIBDIR          install library in LIBDIR [PREFIX/lib]
  --incdir=DIR             install headers in DIR [PREFIX/include]
  --pkgdir=DIR             install pkg-config files in DIR [LIBDIR/pkgconfig]
EOF
  exit 0
}

validate_lib() {
   return 0
}

for opt do
    optval="${opt#*=}"
    case "$opt" in
        --help|-h) show_help
        ;;
        *)
            optname="${opt%%=*}"
            optname="${optname#--}"
            eval $optname='$optval'
        ;;
    esac
done

libdir=${libdir:-${prefix}/lib}
incdir=${incdir:-${prefix}/include}
pkgdir=${pkgdir:-${libdir}/pkgconfig}

[ -z ${ssedir} ] && [ -z ${avxdir} ] && die "No SL-HDR install directory found."

if [ ! -z ${ssedir} ] ; then
   [ -d ${ssedir} ] && validate_lib ${ssedir} || die "No SSE lib found in ${ssedir}"
fi

if [ ! -z ${avxdir} ] ; then
   [ -d ${avxdir} ] && validate_lib ${avxdir} || die "No AVX lib found in ${avxdir}"
fi

cat > config.mak <<EOF
  CXX= ${cxx}
  CFLAGS= -Wall -O3
  SSE_CFLAGS= -msse4.2
  AVX2_CFLAGS= -mavx2
  SSE_FOLDER=${ssedir}
  AVX2_FOLDER=${avxdir}

	PKGDIR=${pkgdir}
	INCDIR=${incdir}
	LIBDIR=${libdir}
EOF

exit 0
